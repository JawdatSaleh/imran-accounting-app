<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حسابات عمران الخليج – Firebase</title>

  <style>
    body { font-family: Arial, Tahoma, sans-serif; background:#f6f7fb; margin:0; color:#222; }
    header { background:#0d2b55; color:#fff; padding:14px 18px; }
    header h1 { margin:0; font-size:20px; }
    .container { max-width:1100px; margin:20px auto; background:#fff; padding:18px; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,.06); }
    .grid { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; }
    .card { background:#0d2b55; color:#fff; padding:14px; border-radius:12px; text-align:center; }
    .card small { opacity:.8; display:block; margin-bottom:6px }
    .card b { font-size:18px }
    .row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    input, select, button { padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:14px; }
    button { background:#1e5bd7; color:#fff; border:none; cursor:pointer }
    button:hover { filter:brightness(.98) }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { border-bottom:1px solid #eee; padding:10px; text-align:center; }
    thead th { background:#0d2b55; color:#fff; position:sticky; top:0; }
    .danger { background:#d7263d }
    .success { background:#0a8f5a }
    .muted { color:#666; }
    .login { max-width:420px; margin:40px auto; text-align:center; }
  </style>

  <!-- Firebase SDKs (modules) -->
  <script type="module">
    /******** Firebase imports ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

    /******** Your Firebase config (from your project) ********/
    const firebaseConfig = {
      apiKey: "AIzaSyCKz2deoXAI_jBcclRuQS1bZCIROLZaYzs",
      authDomain: "omran-accounting.firebaseapp.com",
      projectId: "omran-accounting",
      storageBucket: "omran-accounting.firebasestorage.app",
      messagingSenderId: "839133682089",
      appId: "1:839133682089:web:6b2f521e55dc5183848cb8",
      measurementId: "G-NE88J3J52F"
    };

    /******** Init Firebase ********/
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const entriesRef = collection(db, "entries");

    /******** App state ********/
    const users = { A1: "1234", A2: "5678" };
    const categories = ["عهد مسجد المدينة","مصاريف A1","مصاريف A2","مصاريف المؤسسة","ديون"];
    let currentUser = null;
    let entries = [];

    /******** Helpers (UI) ********/
    const $ = (s)=>document.querySelector(s);
    const tbody = $("#entriesBody");

    function translateType(t){
      if(t==="expense") return "مصروف";
      if(t==="income") return "إيراد";
      if(t==="transfer") return "تحويل";
      return t;
    }
    function translateLocation(l){ return l==="cash" ? "الصندوق" : l==="bank" ? "البنك" : l; }

    function updateTotals(){
      let totalExpenses=0,totalIncome=0,cash=0,bank=0;
      const catTotals = Object.fromEntries(categories.map(c=>[c,0]));

      entries.forEach(e=>{
        const amount = Number(e.amount||0);
        if(e.type==="expense"){
          totalExpenses += amount;
          if(e.location==="cash") cash -= amount; else bank -= amount;
          if(catTotals[e.category]!=null) catTotals[e.category]+=amount;
        } else if(e.type==="income"){
          totalIncome += amount;
          if(e.location==="cash") cash += amount; else bank += amount;
        } else if(e.type==="transfer"){
          if(e.location==="cash"){ cash -= amount; bank += amount; }
          else { bank -= amount; cash += amount; }
        }
      });

      $("#totalExpenses").textContent = totalExpenses.toFixed(2)+" ر.س";
      $("#totalIncome").textContent  = totalIncome.toFixed(2)+" ر.س";
      $("#cashBalance").textContent  = cash.toFixed(2)+" ر.س";
      $("#bankBalance").textContent  = bank.toFixed(2)+" ر.س";
    }

    function renderEntries(){
      tbody.innerHTML = "";
      entries.forEach(e=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${e.id?.slice?.(0,6) || e.id || ""}</td>
          <td>${e.date || ""}</td>
          <td>${translateType(e.type)}</td>
          <td>${Number(e.amount||0).toFixed(2)}</td>
          <td>${e.category||""}</td>
          <td>${translateLocation(e.location)}</td>
          <td>${e.user||""}</td>
          <td>${e.notes||""}</td>
          <td><button class="danger" onclick="deleteEntry('${e.id}')">حذف</button></td>
        `;
        tbody.appendChild(tr);
      });
      updateTotals();
    }

    function populateCategories(){
      const sel = $("#entryCategory");
      sel.innerHTML = "";
      categories.forEach(c=>{
        const opt=document.createElement("option");
        opt.value=c; opt.textContent=c;
        sel.appendChild(opt);
      });
    }

    /******** Firebase CRUD wrappers (exposed on window) ********/
    async function loadEntries(){
      // order by server time (if exists) then fallback to date string
      const q = query(entriesRef, orderBy("createdAt", "desc"));
      const snap = await getDocs(q).catch(async ()=>{
        // if rules disallow orderBy(createdAt) on existing docs lacking field:
        return await getDocs(entriesRef);
      });

      const list = [];
      snap.forEach(d=> list.push({ id: d.id, ...d.data() }));
      // if no createdAt, sort by date string desc
      list.sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")));
      entries = list;
      renderEntries();
    }

    async function saveEntry(entry){
      await addDoc(entriesRef, { ...entry, createdAt: serverTimestamp() });
    }

    async function removeEntry(id){
      await deleteDoc(doc(db, "entries", id));
    }

    // expose
    window.loadEntries = loadEntries;
    window.saveEntry  = saveEntry;
    window.deleteEntry = async (id)=>{
      if(!confirm("تأكيد حذف السجل؟")) return;
      await removeEntry(id);
      await loadEntries();
    };

    /******** Auth-less login (simple local users) ********/
    window.login = async ()=>{
      const u = $("#usernameSelect").value;
      const p = $("#passwordInput").value;
      if(users[u] && users[u]===p){
        currentUser = u;
        $("#loginBox").style.display="none";
        $("#app").style.display="block";
        $("#entryDate").valueAsDate = new Date();
        populateCategories();
        await loadEntries();
      } else {
        alert("❌ اسم المستخدم أو كلمة المرور غير صحيحة");
      }
    };

    /******** Form handlers ********/
    window.submitEntry = async (forcedType)=>{
      if(!currentUser){ alert("يرجى تسجيل الدخول أولاً"); return; }
      const date = $("#entryDate").value;
      const type = forcedType || $("#entryType").value;
      const amount = parseFloat($("#entryAmount").value);
      const category = $("#entryCategory").value;
      const location = $("#entryLocation").value;
      const notes = $("#entryNotes").value;

      if(!date || Number.isNaN(amount) || !category || !location){
        alert("الرجاء إدخال جميع الحقول المطلوبة"); return;
      }

      const entry = { date, type, amount, category, location, user: currentUser, notes };
      await saveEntry(entry);
      // reset a bit
      $("#entryAmount").value = "";
      $("#entryNotes").value  = "";
      await loadEntries();
      alert("✅ تم حفظ السجل في Firebase");
    };

    // init categories on load (even before login for dropdown population if needed)
    populateCategories();
  </script>
</head>
<body>

  <header>
    <h1>حسابات عمران الخليج – يعمل بـ Firebase Firestore</h1>
  </header>

  <!-- شاشة الدخول -->
  <div id="loginBox" class="container login">
    <h3>تسجيل الدخول</h3>
    <div class="row" style="justify-content:center">
      <select id="usernameSelect">
        <option value="A1">A1</option>
        <option value="A2">A2</option>
      </select>
      <input id="passwordInput" type="password" placeholder="كلمة المرور" />
      <button onclick="login()">دخول</button>
    </div>
    <p class="muted">ملاحظة: هذا تسجيل مبسّط داخل الصفحة (بدون Firebase Auth) كما كان في إصدار Google Sheets.</p>
  </div>

  <!-- التطبيق -->
  <div id="app" class="container" style="display:none;">
    <div class="grid">
      <div class="card"><small>إجمالي المصروفات</small><b id="totalExpenses">0 ر.س</b></div>
      <div class="card"><small>إجمالي الإيرادات</small><b id="totalIncome">0 ر.س</b></div>
      <div class="card"><small>رصيد الصندوق</small><b id="cashBalance">0 ر.س</b></div>
      <div class="card"><small>رصيد البنك</small><b id="bankBalance">0 ر.س</b></div>
    </div>

    <h3 style="margin-top:16px">إضافة عملية</h3>
    <div class="row">
      <input type="date" id="entryDate">
      <select id="entryType">
        <option value="expense">مصروف</option>
        <option value="income">إيراد</option>
        <option value="transfer">تحويل</option>
      </select>
      <input type="number" id="entryAmount" step="0.01" placeholder="المبلغ (ر.س)">
      <select id="entryCategory"></select>
      <select id="entryLocation">
        <option value="cash">الصندوق</option>
        <option value="bank">البنك</option>
      </select>
      <input type="text" id="entryNotes" placeholder="ملاحظات">
      <button class="success" onclick="submitEntry()">إضافة</button>
    </div>

    <h3 style="margin-top:12px">السجلات</h3>
    <div style="overflow:auto; max-height:60vh;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>التاريخ</th>
            <th>النوع</th>
            <th>المبلغ</th>
            <th>الفئة</th>
            <th>الموقع</th>
            <th>المستخدم</th>
            <th>ملاحظات</th>
            <th>إجراء</th>
          </tr>
        </thead>
        <tbody id="entriesBody"></tbody>
      </table>
    </div>
  </div>
</body>
</html>
