<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>حسابات</title>
  <style>
    body { font-family: "Cairo", sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #222; }
    h1 { text-align: center; color: #333; }
    .login-box, #app { max-width: 700px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #0077cc; color: white; }
    input, select, button { padding: 8px; margin: 5px; }
    .totals { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .stat { background: #eee; border-radius: 8px; padding: 10px; flex: 1; min-width: 120px; text-align: center; }
    .value { font-weight: bold; font-size: 1.2em; color: #0077cc; }
  </style>
</head>
<body>

  <h1>📊 تطبيق المحاسبة</h1>

  <!-- شاشة تسجيل الدخول -->
  <div id="loginScreen" class="login-box">
    <h3>تسجيل الدخول</h3>
    <label>اسم المستخدم:</label>
    <select id="usernameSelect">
      <option value="A1">A1</option>
      <option value="A2">A2</option>
    </select><br>
    <label>كلمة المرور:</label>
    <input type="password" id="passwordInput"><br>
    <button onclick="login()">تسجيل الدخول</button>
  </div>

  <!-- التطبيق -->
  <div id="app" style="display:none;">
    <h3>إضافة عملية</h3>
    <label>التاريخ:</label>
    <input type="date" id="entryDate"><br>
    <label>النوع:</label>
    <select id="entryType">
      <option value="expense">مصروف</option>
      <option value="income">إيراد</option>
      <option value="transfer">تحويل</option>
    </select><br>
    <label>المبلغ:</label>
    <input type="number" id="entryAmount" step="0.01"><br>
    <label>الفئة:</label>
    <select id="entryCategory"></select><br>
    <label>الموقع:</label>
    <select id="entryLocation">
      <option value="cash">الصندوق</option>
      <option value="bank">البنك</option>
    </select><br>
    <label>ملاحظات:</label>
    <input type="text" id="entryNotes"><br>
    <button onclick="submitEntry()">➕ إضافة</button>

    <h3>📄 السجلات</h3>
    <table>
      <thead>
        <tr>
          <th>المعرف</th>
          <th>التاريخ</th>
          <th>النوع</th>
          <th>المبلغ</th>
          <th>الفئة</th>
          <th>الموقع</th>
          <th>المستخدم</th>
          <th>ملاحظات</th>
          <th>حذف</th>
        </tr>
      </thead>
      <tbody id="entriesBody"></tbody>
    </table>

    <div class="totals">
      <div class="stat"><strong>إجمالي المصروفات</strong><div class="value" id="totalExpenses">0</div></div>
      <div class="stat"><strong>إجمالي الإيرادات</strong><div class="value" id="totalIncome">0</div></div>
      <div class="stat"><strong>رصيد الصندوق</strong><div class="value" id="cashBalance">0</div></div>
      <div class="stat"><strong>رصيد البنك</strong><div class="value" id="bankBalance">0</div></div>
    </div>

    <h3>📊 إجمالي الفئات</h3>
    <div id="categoryTotals" class="totals"></div>
  </div>

<script>
const users = { A1: '1234', A2: '5678' };
const categories = ['عهد مسجد المدينة','مصاريف A1','مصاريف A2','مصاريف المؤسسة','ديون'];
let currentUser = null;
let entries = [];

// ✅ إعداد رابط Google Apps Script
const remoteConfig = {
  type: 'gSheet',
  gSheet: {
    url: 'https://script.google.com/macros/s/AKfycbz3UCd43zN9INdUYh4wQ8xxAMGy4ltaX2I2a24tdGeMOk5i2k6kmoIQXUmPaLnVlScK/exec'
  }
};

// ✅ تحميل البيانات من Google Sheets
async function loadEntries() {
  try {
    const resp = await fetch(remoteConfig.gSheet.url, { method: 'GET', mode: 'cors' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const data = await resp.json();
    entries = data.map(item => ({
      id: item.id, date: item.date, type: item.type, amount: Number(item.amount),
      category: item.category, location: item.location, notes: item.notes || '', user: item.user || ''
    }));
    updateUI();
  } catch (err) {
    console.error('❌ خطأ أثناء تحميل البيانات:', err);
    alert('⚠️ حدث خطأ أثناء تحميل البيانات من Google Sheets');
  }
}

// ✅ حفظ البيانات إلى Google Sheets
async function saveEntries() {
  try {
    const response = await fetch(remoteConfig.gSheet.url, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ entries })
    });
    if (!response.ok) throw new Error(`فشل الحفظ: ${response.status}`);
    alert('✅ تم حفظ البيانات بنجاح في Google Sheets');
  } catch (err) {
    console.error('❌ خطأ أثناء حفظ البيانات:', err);
    alert('⚠️ حدث خطأ أثناء حفظ البيانات إلى Google Sheets');
  }
}

// تسجيل الدخول
function login() {
  const user = document.getElementById('usernameSelect').value;
  const pass = document.getElementById('passwordInput').value;
  if (users[user] && users[user] === pass) {
    currentUser = user;
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('entryDate').valueAsDate = new Date();
    loadEntries();
  } else {
    alert('❌ اسم المستخدم أو كلمة المرور غير صحيحة');
  }
}

// تعبئة الفئات
const categorySelect = document.getElementById('entryCategory');
categories.forEach(cat => {
  const opt = document.createElement('option');
  opt.value = cat;
  opt.textContent = cat;
  categorySelect.appendChild(opt);
});

// إضافة سجل جديد
function submitEntry() {
  if (!currentUser) return alert('الرجاء تسجيل الدخول أولاً');
  const date = document.getElementById('entryDate').value;
  const type = document.getElementById('entryType').value;
  const amount = parseFloat(document.getElementById('entryAmount').value);
  const category = document.getElementById('entryCategory').value;
  const location = document.getElementById('entryLocation').value;
  const notes = document.getElementById('entryNotes').value;

  if (!date || isNaN(amount) || !category || !location) return alert('الرجاء إدخال جميع البيانات المطلوبة');

  const entry = { id: Date.now(), date, type, amount, category, location, notes, user: currentUser };
  entries.push(entry);
  clearEntryForm(); updateUI(); saveEntries();
}

function clearEntryForm() {
  document.getElementById('entryAmount').value = '';
  document.getElementById('entryNotes').value = '';
}

// حذف سجل
function deleteEntry(id) {
  entries = entries.filter(e => e.id !== id);
  updateUI(); saveEntries();
}

// تحديث الواجهة
function updateUI() { renderEntries(); updateTotals(); }

function renderEntries() {
  const tbody = document.getElementById('entriesBody');
  tbody.innerHTML = '';
  entries.forEach(entry => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${entry.id}</td>
      <td>${entry.date}</td>
      <td>${translateType(entry.type)}</td>
      <td>${entry.amount.toFixed(2)} ر.س</td>
      <td>${entry.category}</td>
      <td>${translateLocation(entry.location)}</td>
      <td>${entry.user}</td>
      <td>${entry.notes}</td>
      <td><button onclick="deleteEntry(${entry.id})">🗑️</button></td>`;
    tbody.appendChild(tr);
  });
}

function translateType(t) {
  switch (t) {
    case 'expense': return 'مصروف';
    case 'income': return 'إيراد';
    case 'transfer': return 'تحويل';
    default: return t;
  }
}
function translateLocation(l) { return l === 'cash' ? 'الصندوق' : 'البنك'; }

function updateTotals() {
  let totalExpenses = 0, totalIncome = 0, cash = 0, bank = 0;
  const catTotals = {}; categories.forEach(c => catTotals[c] = 0);
  entries.forEach(e => {
    if (e.type === 'expense') {
      totalExpenses += e.amount; e.location === 'cash' ? cash -= e.amount : bank -= e.amount;
      if (catTotals[e.category] !== undefined) catTotals[e.category] += e.amount;
    } else if (e.type === 'income') {
      totalIncome += e.amount; e.location === 'cash' ? cash += e.amount : bank += e.amount;
    } else if (e.type === 'transfer') {
      if (e.location === 'cash') { cash -= e.amount; bank += e.amount; } else { bank -= e.amount; cash += e.amount; }
    }
  });
  document.getElementById('totalExpenses').textContent = totalExpenses.toFixed(2);
  document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
  document.getElementById('cashBalance').textContent = cash.toFixed(2);
  document.getElementById('bankBalance').textContent = bank.toFixed(2);
  const catContainer = document.getElementById('categoryTotals');
  catContainer.innerHTML = '';
  categories.forEach(cat => {
    const div = document.createElement('div');
    div.className = 'stat';
    div.innerHTML = `<strong>${cat}</strong><div class="value">${catTotals[cat].toFixed(2)}</div>`;
    catContainer.appendChild(div);
  });
}
</script>

</body>
</html>
